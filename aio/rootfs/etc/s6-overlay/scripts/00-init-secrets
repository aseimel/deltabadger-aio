#!/command/with-contenv bash
# Generate secrets on first run and persist them

set -e

DATA_DIR="${DELTABADGER_DATA_DIR:-/data}"
SECRETS_FILE="${DATA_DIR}/secrets/.env.secrets"

# Create directories
mkdir -p "${DATA_DIR}/secrets"
mkdir -p "${DATA_DIR}/postgresql/data"
mkdir -p "${DATA_DIR}/redis"
mkdir -p "${DATA_DIR}/app/storage"

# Check if secrets already provided via environment
if [ -n "$SECRET_KEY_BASE" ] && [ -n "$DEVISE_SECRET_KEY" ] && [ -n "$APP_ENCRYPTION_KEY" ]; then
    echo "Using secrets from environment variables"
    exit 0
fi

# Check for existing secrets file
if [ -f "$SECRETS_FILE" ]; then
    echo "Loading existing secrets from ${SECRETS_FILE}"
    set -a
    source "$SECRETS_FILE"
    set +a
else
    echo "First run detected - generating secrets..."

    # Generate cryptographically secure secrets
    SECRET_KEY_BASE=$(openssl rand -hex 64)
    DEVISE_SECRET_KEY=$(openssl rand -hex 64)
    APP_ENCRYPTION_KEY=$(openssl rand -hex 16)

    # Write secrets file
    cat > "$SECRETS_FILE" << EOF
# Auto-generated secrets - DO NOT DELETE
# Generated on: $(date -Iseconds)
SECRET_KEY_BASE=${SECRET_KEY_BASE}
DEVISE_SECRET_KEY=${DEVISE_SECRET_KEY}
APP_ENCRYPTION_KEY=${APP_ENCRYPTION_KEY}
EOF

    chmod 600 "$SECRETS_FILE"
    echo "Secrets generated and saved to ${SECRETS_FILE}"
fi

# Export to s6 environment for other services
mkdir -p /run/s6/container_environment
printf "%s" "$SECRET_KEY_BASE" > /run/s6/container_environment/SECRET_KEY_BASE
printf "%s" "$DEVISE_SECRET_KEY" > /run/s6/container_environment/DEVISE_SECRET_KEY
printf "%s" "$APP_ENCRYPTION_KEY" > /run/s6/container_environment/APP_ENCRYPTION_KEY

echo "Secrets loaded into environment"
